<!DOCTYPE html>
<html>
<head>
  <title>Voice Notes Formatter</title>

  <style>

    body {
      font-family: Arial;
      text-align: center;
      margin-top: 40px;
      background: #f4f6f9;
    }

    h1 {
      font-size: 42px;
    }

    #status {
      font-size: 20px;
      height: 30px;
      margin-bottom: 10px;
      font-weight: bold;
    }

    .listening {
      color: red;
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0% {opacity:1;}
      50% {opacity:0.4;}
      100% {opacity:1;}
    }

    textarea {

      width: 70%;
      height: 140px;
      font-size: 18px;
      padding: 10px;
      margin-top: 15px;

    }

    button {

      padding: 12px 25px;
      font-size: 16px;
      margin: 8px;
      border: none;
      border-radius: 6px;
      cursor: pointer;

    }

    #startBtn { background:#007bff; color:white; }
    #continueBtn { background:#17a2b8; color:white; }
    #stopBtn { background:#dc3545; color:white; }
    #formatBtn { background:#28a745; color:white; }

    #response {

      margin-top: 30px;
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
      text-align: left;

    }

    .box {

      background:white;
      padding:15px;
      border-radius:8px;
      margin-top:15px;
      box-shadow:0 2px 8px rgba(0,0,0,0.1);

    }

    .label {
      font-weight:bold;
      margin-bottom:5px;
    }

  </style>

</head>
<body>

<h1>üé§ Voice Notes Formatter</h1>

<div id="status">Idle</div>

<button id="startBtn">Start Listening</button>
<button id="continueBtn">Continue Listening</button>
<button id="stopBtn">Stop</button>
<button id="formatBtn">Format with AI</button>

<br>

<textarea id="textInput" placeholder="Your spoken notes will appear here..."></textarea>

<div id="response"></div>


<script>

const webhookUrl = "https://n8n.knotastain.com/webhook-test/format-message";

let recognition;
let listening = false;
let silenceTimer;


// Initialize speech recognition
function initSpeech() {

  recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();

  recognition.lang = "en-US";

  recognition.continuous = true;

  recognition.interimResults = false;

  recognition.maxAlternatives = 1;


  recognition.onstart = () => {

    listening = true;

    document.getElementById("status").innerHTML = "üî¥ Listening...";
    document.getElementById("status").classList.add("listening");

  };


  recognition.onresult = (event) => {

    clearTimeout(silenceTimer);

    const lastResult = event.results[event.results.length - 1];

    if (lastResult.isFinal) {

      const transcript = lastResult[0].transcript;

      document.getElementById("textInput").value += transcript + " ";

    }

    silenceTimer = setTimeout(stopListening, 5000);

  };


  recognition.onerror = () => stopListening();


  recognition.onend = () => {

    listening = false;

    document.getElementById("status").innerHTML = "Idle";

    document.getElementById("status").classList.remove("listening");

  };

}


// Start fresh listening
document.getElementById("startBtn").onclick = () => {

  stopListening();

  document.getElementById("textInput").value = "";

  initSpeech();

  recognition.start();

};


// Continue listening (append)
document.getElementById("continueBtn").onclick = () => {

  if (!listening) {

    initSpeech();

    recognition.start();

  }

};


// Stop listening
document.getElementById("stopBtn").onclick = stopListening;


function stopListening() {

  if (recognition && listening) {

    recognition.stop();

  }

}



// Format with AI
document.getElementById("formatBtn").onclick = async () => {

  const originalText = document.getElementById("textInput").value.trim();

  if (!originalText) {

    alert("No text to format.");

    return;

  }

  document.getElementById("response").innerHTML = "Formatting with AI...";


  try {

    const res = await fetch(webhookUrl, {

      method:"POST",

      headers:{
        "Content-Type":"application/json"
      },

      body: JSON.stringify({
        text: originalText
      })

    });


    const data = await res.json();

    let formatted;


    if (typeof data === "string") {

      formatted = JSON.parse(data).text;

    }

    else if (data.text) {

      formatted = data.text;

    }

    else {

      formatted = JSON.stringify(data);

    }


    document.getElementById("response").innerHTML = `

      <div class="box">
        <div class="label">Original Note:</div>
        ${originalText}
      </div>

      <div class="box">
        <div class="label">AI Formatted Note:</div>
        ${formatted}
      </div>

    `;


  }
  catch {

    document.getElementById("response").innerHTML = "‚ùå Error formatting note.";

  }

};

</script>

</body>
</html>
