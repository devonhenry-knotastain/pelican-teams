<!DOCTYPE html>
<html>
<head>
  <title>Voice Notes Formatter</title>

  <style>

    body {
      font-family: Arial;
      text-align: center;
      margin-top: 40px;
      background: #f4f6f9;
    }

    h1 {
      font-size: 42px;
    }

    #status {
      font-size: 20px;
      height: 30px;
      margin-bottom: 10px;
      font-weight: bold;
    }

    .listening {
      color: red;
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0% {opacity:1;}
      50% {opacity:0.4;}
      100% {opacity:1;}
    }

    textarea {
      width: 70%;
      height: 120px;
      font-size: 18px;
      padding: 10px;
      margin-top: 15px;
    }

    button {

      padding: 12px 25px;
      font-size: 16px;
      margin: 8px;
      border: none;
      border-radius: 6px;
      cursor: pointer;

    }

    #startBtn { background:#007bff; color:white; }
    #continueBtn { background:#17a2b8; color:white; }
    #stopBtn { background:#dc3545; color:white; }
    #formatBtn { background:#28a745; color:white; }

    #response {

      margin-top: 30px;
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
      text-align: left;

    }

    .box {

      background:white;
      padding:15px;
      border-radius:8px;
      margin-top:15px;
      box-shadow:0 2px 8px rgba(0,0,0,0.1);

    }

    .label {
      font-weight:bold;
      margin-bottom:5px;
    }

  </style>

</head>
<body>

<h1>üé§ Voice Notes Formatter</h1>

<div id="status"></div>

<button id="startBtn">Start Listening</button>
<button id="continueBtn">Continue Listening</button>
<button id="stopBtn">Stop</button>
<button id="formatBtn">Format with AI</button>

<br>

<textarea id="textInput" placeholder="Your spoken notes will appear here..."></textarea>

<div id="response"></div>


<script>

const webhookUrl = "https://n8n.knotastain.com/webhook-test/format-message";

let recognition;
let listening = false;


// INIT SPEECH ENGINE
function initSpeech() {

  recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();

  recognition.lang = "en-US";

  recognition.continuous = true;

  recognition.interimResults = true;

  recognition.maxAlternatives = 1;


  let silenceTimer;


  recognition.onstart = () => {

    listening = true;

    document.getElementById("status").innerHTML = "üî¥ Listening...";
    document.getElementById("status").classList.add("listening");

  };


  recognition.onresult = (event) => {

    clearTimeout(silenceTimer);

    let transcript = "";

    for (let i = event.resultIndex; i < event.results.length; i++) {

      transcript += event.results[i][0].transcript;

    }

    document.getElementById("textInput").value += transcript + " ";


    // AUTO STOP after 5 seconds silence
    silenceTimer = setTimeout(() => {

      stopListening();

    }, 5000);

  };


  recognition.onerror = () => stopListening();

  recognition.onend = () => {

    listening = false;

    document.getElementById("status").innerHTML = "Stopped";

    document.getElementById("status").classList.remove("listening");

  };

}


// START NEW
document.getElementById("startBtn").onclick = () => {

  initSpeech();

  document.getElementById("textInput").value = "";

  recognition.start();

};


// CONTINUE
document.getElementById("continueBtn").onclick = () => {

  if (!listening) {

    initSpeech();

    recognition.start();

  }

};


// STOP BUTTON
document.getElementById("stopBtn").onclick = () => {

  stopListening();

};


function stopListening() {

  if (recognition && listening)
    recognition.stop();

}



// FORMAT WITH AI
document.getElementById("formatBtn").onclick = async () => {

  const originalText = document.getElementById("textInput").value;

  if (!originalText) {
    alert("No text to format.");
    return;
  }

  document.getElementById("response").innerHTML = "Formatting...";


  try {

    const res = await fetch(webhookUrl, {

      method:"POST",

      headers:{ "Content-Type":"application/json" },

      body: JSON.stringify({
        text: originalText
      })

    });


    const data = await res.json();


    let formatted;

    if (typeof data === "string")
      formatted = JSON.parse(data).text;

    else if (data.text)
      formatted = data.text;

    else
      formatted = JSON.stringify(data);



    document.getElementById("response").innerHTML = `

      <div class="box">
        <div class="label">Original Note:</div>
        ${originalText}
      </div>

      <div class="box">
        <div class="label">AI Formatted Note:</div>
        ${formatted}
      </div>

    `;


  }
  catch {

    document.getElementById("response").innerHTML = "‚ùå Error formatting note.";

  }

};

</script>

</body>
</html>
